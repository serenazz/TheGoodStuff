import pandas as pd
import matplotlib.pyplot as plt

df=pd.read_csv("all_5.22.csv")
df_guanzhu=pd.read_csv("5.22取消关注用户.csv")
grouped=pd.read_csv("5.22_grouped.csv")
df_cantuan_all = df[df["user_id"].isin([81047,50011,59603,59270,49456,63579,42667,44179,37861,74630,79116,75751,51050,
                                        46023,116487,10051,9172,55088,109689,72193,86093,108273,76850,64782,62510,104106,52329,
                                        44556,50002,68518,13772,64606,40719,84786,59119,75330,71607,54233,18924,14544,49767,58269,
                                        92692,99522,42889,55201,91849,43384,51268,68212,113459,78815,55161,50482,49977,53197,65000,
                                        81400,88318,55013,56904,59120,75069,51435,55304,50469,39157,92162,50537,92632,39871,41851,75060,
                                        91956,34154,59115,61950,92725,50515,53056,52420,108729,71942,60418,52163,49239,49968,52284,59176,
                                        102728,74737,55246,49754,71952,97789,50228,58204,114383,60542,99520,60916,80054,67657,109305,87048,
                                        83001,112089,112026,89558,58290,105299,52762,35860,63921,143551,185700,215524,179489,202065,184094,
                                        179166,184089,191364,173724,89452,152908,184316,169391,171035,189895,216215,197325,208811,179098,249994,
                                        243760,179952,196900,183509,198395,179014,125857,240148,242981,129645,161618,196794,180003,187941,178607,
                                        198388,133178,187594,225667,178991,188335,246556,120192,179159,148519,179606,231421,117456,186187,169540,142374,
                                        142549,170081,18654,190147,243460,196199,58280,47889,203970,215970,179657,215149,63192,179933,180051,105287,215265,
                                        218771,141707,146989,223409,235755,217471,188761,179809,187924,180872,178262,231558,180807,183622,185364,218521,223614,
                                        149937,47207,109089,179696,148987,183584,85642,180746,182170,147447,183885,138525,198358,137395,193449,250787,183947,
                                        104102,218538,183425,169496,42177,250934,163091,145176,199862,179911,158740,179783,137029,158440,199999,202602,185821,
                                        216454,180083,201713,147107,102254,169314,1637,21386,18736,36002,9670,16399,13261,9190,14517,10036,30274,34316,27676,1627,
                                        9194,9170,14717,13310,34327,32671,9947,13013,11716,7535,20563,12508,32588,13696,12544,20734,9399,16200,11387,14152,19288,
                                        11436,9382,9668,12473,14536,12951,9683,20847,11440,11924,12504,12506,17816,17320,9781,12528,19589,9171,96350,94479,67828,
                                        13655,42347,99638,39436,42645,11548,49969,80683,84211,99070,34157,96349,98034,11572,65424,97655,11598,20826,12483,59601,
                                        14444,22032,9771,81949,41465,20595,41427,58377,62823,24665,45367,14456,80970,42802,12433,10008,85655,96352,90619,57627,
                                        52428,9686,34737,84429,71608,85363,43470,12480])][df.columns[0:-3]].sort_values(by="last_order")
df_coupon_all= df[df["user_id"].isin([67621,58336,57309,50151,65718,72142,102722,39917,37234,92796,45676,48987,54992,92348,106607,89404,
                                      49981,9374,64632,80059,50322,84482,80476,81497,59571,88216,6765,49998,92729,50586,55263,108389,57307,
                                      49260,71944,114205,52407,75803,54470,109385,75416,112812,64964,84355,106848,108153,52864,83505,72514,108445,
                                      86568,57676,87133,58979,52021,81618,55087,11399,72969,113529,51591,82533,64017,87429,57617,58439,9824,71333,
                                      53977,122172,59109,80417,95613,49783,54464,57626,54895,58270,45681,40760,101632,49020,59151,37537,65087,44540,
                                      73038,42363,49072,70259,95677,108670,57556,93384,65802,52853,57645,42664,59380,64875,59121,50299,79259,84304,
                                      43924,42390,84619,50909,60864,49053,75746,84260,70209,109698,189546,199474,160187,218935,181492,195009,180855,
                                      208705,215644,146480,199583,245557,132901,87645,202789,198928,178053,211150,230055,135636,184347,131179,141174,
                                      141118,233995,45726,42161,181215,141941,128163,190298,220332,41776,25648,42166,233501,180982,199688,186408,143380,
                                      187972,177387,178537,183964,191180,85343,181841,117123,184242,188236,177373,184393,245272,53171,187524,136430,189631,
                                      177423,229238,193357,260091,189368,184056,59511,43940,167008,177406,164210,104641,250617,223166,186742,250448,181346,
                                      169591,159882,181260,183469,184125,47990,193228,111196,197010,189967,224783,251542,214880,177483,128268,188255,186115,
                                      199696,177548,120400,136237,187222,256296,249744,124359,190455,192372,178644,180078,239421,72599,192745,181789,65775,
                                      172819,180661,181683,178088,118776,185375,177846,109204,186147,219721,208500,177649,225498,183921,113844,239299,184425,
                                      242608,9174,12507,34979,9356,38352,9169,12746,11409,13244,6767,20041,18239,16287,14148,15901,12541,16688,20137,9347,34923,
                                      11943,15325,12456,9692,15916,9387,9428,1635,14516,13694,17308,19850,9385,21108,19475,1555,9677,34980,14541,16813,18649,
                                      13730,12540,28021,8544,13714,7553,32488,13723,9665,18928,16792,9168,13248,59107,14556,98612,64848,65596,43905,41718,13770,
                                      81559,59598,39988,63303,47263,10061,49846,46665,68781,59286,57616,67780,11420,35709,63017,88475,12505,9187,70467,41869,16154,
                                      18160,11383,39869,58492,97266,13237,41489,42790,65778,13049,57599,9693,68820,67773,71688,42504,57596,50001,61309,60505,63843])][df.columns[0:-3]].sort_values(by="last_order")

df_cantuan_bought= df[df["user_id"].isin([64606,75330,120192,138525])][df.columns[0:-3]].sort_values(by="last_order")
df_coupon= df[df["user_id"].isin([195070,9665,42790,57599,59380,20137,57309,93384,9174,72514,67780,
                                  88475,122172,128268,180661,189631,184125,256296,192745,223166,184393,
                                  124359,13049,181492,160187,79259,178053,42166,57616,185375,50001,41869,
                                  72969,71944,20041,92348,60505,112812,16813,177373,39988,118776,12456,81559,
                                  224783,47263,64964,180078,59121,65802,81497,72599])][df.columns[0:-3]].sort_values(by="last_order")
df_coupon_bought=df[df["user_id"].isin([57616,81559,88475,118776,124359,181492,192745])][df.columns[0:-3]].sort_values(by="last_order")
df_cantuan= df[df["user_id"].isin([246490,195070,9670,12483,11387,64606,75069,58290,
                                         75330,67657,99638,163091,9686,143551,170081,191364,
                                         138525,16399,42347,85363,12480,216454,117456,96350,65424,
                                         183425,97655,49977,49239,197325,58377,215524,183947,218538,
                                         198388,104106,35860,45367,52428,14544,193449,10051])][df.columns[0:-3]].sort_values(by="last_order")
df1=pd.merge(df_cantuan,grouped,how='left',on='user_id')
df2=pd.merge(df_cantuan_bought,grouped,how='left',on='user_id')
df3=pd.merge(df_coupon,grouped,how='left',on='user_id')
df4=pd.merge(df_coupon_bought,grouped,how='left',on='user_id')
df5=pd.merge(df_cantuan_all,grouped,how='left',on='user_id')
df6=pd.merge(df_coupon_all,grouped,how='left',on='user_id')

print("参团总分布: ","\n", df5.group.value_counts() )
print("优惠券总分布: ","\n", df6.group.value_counts() )
print("参团消息点开分布: ","\n", df1.group.value_counts())
print("参团消息购买分布: ","\n", df2.group.value_counts())
print("优惠券消息点开分布: ","\n", df3.group.value_counts())
print("优惠券消息购买分布: ","\n", df4.group.value_counts())


df1["group"].plot.hist(by="group", alpha=1)
plt.xlabel("group")
plt.ylabel("number of users")
plt.show()

print("参团提醒点开的用户: ", df_cantuan.shape[0])
print(df_cantuan)
print()
print("参团提醒购买用户: ", df_cantuan_bought.shape[0])
print(df_cantuan_bought)
print()
print("优惠券点开用户: ",df_coupon.shape[0])
print(df_coupon)
print()
print("优惠券购买用户: ",df_coupon_bought.shape[0])
print(df_coupon_bought)


df_guanzhu["cancel"]=1
df_with_guanzhu=pd.merge(df,df_guanzhu, how="left",on="user_id")
df_with_guanzhu_with_group=pd.merge(df_with_guanzhu,grouped,how="left",on="user_id")
df_with_guanzhu_with_group.cancel=df_with_guanzhu_with_group.cancel.fillna(0)
canceled_lost = df_with_guanzhu_with_group[df_with_guanzhu_with_group["cancel"]==1]

guanzhu_cantuan = pd.merge(df_cantuan_all,df_with_guanzhu_with_group,how="left",on ="user_id")
guanzhu_coupon = pd.merge(df_coupon_all, df_with_guanzhu_with_group,how="left",on ="user_id")
suc_cantuan=guanzhu_cantuan[guanzhu_cantuan["cancel"]==0]
suc_coupon=guanzhu_coupon[guanzhu_coupon["cancel"]==0]

print("参团成功的统计",suc_cantuan.group.value_counts())
print("优惠券成功的统计",suc_coupon.group.value_counts())
print("所有组数统计",grouped.group.value_counts())
print("取消组数统计",canceled_lost.group.value_counts())


